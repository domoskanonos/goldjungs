<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Die Goldjungs – Responsive Jump'n'Run</title>
  <!-- Phaser 3 über CDN -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
    canvas {
      display: block;
    }
  </style>
</head>
<body>
<script>
  // Dynamische Bildschirmgröße
  const gameWidth = window.innerWidth;
  const gameHeight = window.innerHeight;

  const config = {
    type: Phaser.AUTO,
    width: gameWidth,
    height: gameHeight,
    physics: {
      default: 'arcade',
      arcade: {
        gravity: { y: 500 },
        debug: false
      }
    },
    scene: {
      preload: preload,
      create: create,
      update: update
    }
  };

  const game = new Phaser.Game(config);

  let player, cursors;
  let ground;
  let enemies;
  let bullets;
  let lastFired = 0;
  let lives = 3;
  let lifeText;

  function preload() {
    // Lade Platzhalter-Grafiken (ersetze diese URLs durch eigene Assets)
    this.load.image('ground', 'https://labs.phaser.io/assets/sprites/platform.png');
    this.load.image('player', 'https://labs.phaser.io/assets/sprites/phaser-dude.png');
    this.load.image('enemy', 'https://labs.phaser.io/assets/sprites/space-baddie.png');
    this.load.image('bullet', 'https://labs.phaser.io/assets/sprites/bullets/bullet7.png');
  }

  function create() {
    // Erstelle den Boden als statische Plattform, relativ am unteren Rand
    ground = this.physics.add.staticGroup();
    // Platziere den Boden in der Mitte der Breite und bei 95% der Höhe
    ground.create(gameWidth / 2, gameHeight * 0.95, 'ground')
          .setScale(2)
          .refreshBody();

    // Spieler erstellen an relativer Position (z. B. 10% von links, 67% von oben)
    player = this.physics.add.sprite(gameWidth * 0.1, gameHeight * 0.67, 'player');
    player.setBounce(0.1);
    player.setCollideWorldBounds(true);
    player.setScale(1);
    player.lives = lives;
    player.collisionCount = 0;
    this.physics.add.collider(player, ground);

    // Gegner-Gruppe erstellen und Kollision mit Boden aktivieren
    enemies = this.physics.add.group();
    this.physics.add.collider(enemies, ground);

    // Starte den ersten Gegner-Spawning-Timer
    spawnNextEnemy.call(this);

    // Bullets-Gruppe erstellen
    bullets = this.physics.add.group();

    // Kollisionen zwischen Spieler und Gegner, sowie Bullets und Gegner
    this.physics.add.overlap(player, enemies, hitEnemy, null, this);
    this.physics.add.overlap(bullets, enemies, bulletHitsEnemy, null, this);

    // Eingabesteuerung
    cursors = this.input.keyboard.createCursorKeys();
    this.input.keyboard.on('keydown-SPACE', shoot, this);

    // Anzeige der Leben oben rechts, relativ positioniert
    lifeText = this.add.text(gameWidth * 0.98, gameHeight * 0.05, 'Leben: ' + player.lives, { font: `${Math.round(gameHeight * 0.05)}px Arial`, fill: '#000' });
    lifeText.setOrigin(1, 0);

    // Überschrift oben in der Mitte
    const titleText = this.add.text(gameWidth / 2, gameHeight * 0.05, 'Die Goldjungs', { font: `${Math.round(gameHeight * 0.07)}px fantasy`, fill: '#000' });
    titleText.setOrigin(0.5, 0);
  }

  function update(time, delta) {
    // Spielerbewegung
    if (cursors.left.isDown) {
      player.setVelocityX(-160);
      player.flipX = true;
    } else if (cursors.right.isDown) {
      player.setVelocityX(160);
      player.flipX = false;
    } else {
      player.setVelocityX(0);
    }

    if (cursors.up.isDown && player.body.touching.down) {
      player.setVelocityY(-330);
    }

    // Entferne Gegner, die links aus dem Bild laufen
    enemies.getChildren().forEach(enemy => {
      if (enemy.x < -50) {
        enemy.destroy();
      }
    });

    // Entferne Bullets, die außerhalb des Bildschirms sind
    bullets.getChildren().forEach(bullet => {
      if (bullet.x > gameWidth + 50 || bullet.x < -50) {
        bullet.destroy();
      }
    });
  }

  // Funktion, um den nächsten Gegner mit zufälliger Verzögerung zu spawnen
  function spawnNextEnemy() {
    let delay = Phaser.Math.Between(2000, 12000); // 2 bis 12 Sekunden
    console.log('Nächster Gegner in ' + delay + ' ms');
    this.time.addEvent({
      delay: delay,
      callback: spawnEnemy,
      callbackScope: this,
      loop: false
    });
  }

  // Gegner spawnen relativ zum Bildschirm
  function spawnEnemy() {
    let groundObj = ground.getChildren()[0];
    // Berechne die Y-Position so, dass der Gegner (mit Origin 0.5, 1) direkt auf dem Boden erscheint
    let enemyImage = this.textures.get('enemy').getSourceImage();
    let enemyHeight = enemyImage ? enemyImage.height : 32;
    let enemyY = groundObj.y; // Da der Boden am unteren Rand liegt
    // Gegner soll rechts außerhalb des Bildschirms spawnen (z.B. 5% der Bildschirmbreite als Offset)
    let enemyX = gameWidth + gameWidth * 0.05;
    let enemy = enemies.create(enemyX, enemyY, 'enemy');
    enemy.setOrigin(0.5, 1);
    enemy.setScale(1);
    enemy.setVelocityX(-Phaser.Math.Between(50, 150));
    enemy.setCollideWorldBounds(false);
    enemy.setBounce(0);
    enemy.setDepth(2);
    console.log('Gegner gespawnt an x = ' + enemy.x + ', y = ' + enemy.y);
    // Starte den Timer für den nächsten Gegner
    spawnNextEnemy.call(this);
  }

  // Funktion, wenn der Spieler von einem Gegner getroffen wird
  function hitEnemy(player, enemy) {
    enemy.destroy();
    player.collisionCount++;
    // Visueller Effekt: Spieler wird verkleinert
    player.setScale(Math.max(0.5, 1 - player.collisionCount * 0.25));
    if (player.collisionCount >= 2) {
      player.lives--;
      lifeText.setText('Leben: ' + player.lives);
      player.collisionCount = 0;
      if (player.lives > 0) {
        player.setScale(1);
      } else {
        this.scene.pause();
        const gameOverText = this.add.text(gameWidth / 2, gameHeight / 2, 'Game Over', { font: `${Math.round(gameHeight * 0.1)}px Arial`, fill: '#f00' });
        gameOverText.setOrigin(0.5);
      }
    }
  }

  // Funktion, wenn ein Bullet einen Gegner trifft
  function bulletHitsEnemy(bullet, enemy) {
    bullet.destroy();
    enemy.destroy();
  }

  // Schießen-Funktion
  function shoot() {
    if (this.time.now < lastFired) return;
    lastFired = this.time.now + 500;
    let bullet = bullets.create(player.x, player.y, 'bullet');
    bullet.setCollideWorldBounds(false);
    bullet.setVelocityX(player.flipX ? -300 : 300);
    bullet.body.allowGravity = false;
  }
</script>
</body>
</html>
